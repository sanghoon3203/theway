// üìÅ Models/TradeItem.swift - ÌôïÏû•Îêú Î≤ÑÏ†Ñ
import Foundation
import SwiftUI
// MARK: - ÌôïÏû•Îêú TradeItem
struct TradeItem: Identifiable, Codable, Equatable {
    let id = String
    // Í∏∞Î≥∏ ÏïÑÏù¥ÌÖú Ï†ïÎ≥¥
    let itemId: String  // ÏÑúÎ≤ÑÏùò item_master ID
    let name: String
    let category: String
    let subcategory: String?
    
    // Îì±Í∏â Î∞è ÏöîÍµ¨ÏÇ¨Ìï≠
    let grade: ItemGrade
    let rarity: ItemRarity
    let requiredLicense: LicenseLevel
    let requiredLevel: Int
    let requiredStats: RequiredStats?
    
    // Í∞ÄÍ≤© Ï†ïÎ≥¥
    let basePrice: Int
    var currentPrice: Int
    var marketValue: Int?
    let purchasePrice: Int?  // Íµ¨Îß§ÌñàÏùÑ ÎïåÏùò Í∞ÄÍ≤©
    
    // ÏïÑÏù¥ÌÖú ÏÜçÏÑ±
    let weight: Double
    let durability: Int?
    var currentDurability: Int?
    let maxStack: Int
    let isStackable: Bool
    let isConsumable: Bool
    let isTradeable: Bool
    let isDropable: Bool
    
    // Í∞ïÌôî ÏãúÏä§ÌÖú
    var enhancementLevel: Int = 0
    var enhancementStats: EnhancementStats?
    var socketGems: [SocketGem] = []
    var enchantments: [Enchantment] = []
    var customName: String?
    
    // ÎßàÎ≤ï ÏÜçÏÑ±
    let magicalProperties: [MagicalProperty]
    let specialEffects: [SpecialEffect]
    
    // Ïô∏Ìòï Ï†ïÎ≥¥
    let iconId: Int
    let spriteId: Int?
    let colorScheme: String?
    
    // ÏÑ§Î™Ö ÌÖçÏä§Ìä∏
    let description: String
    let loreText: String?
    
    // Ïù∏Î≤§ÌÜ†Î¶¨ Í¥ÄÎ†®
    var quantity: Int = 1
    var isEquipped: Bool = false
    var equipmentSlot: EquipmentSlot?
    var isLocked: Bool = false
    var isFavorite: Bool = false
    
    // ÏãúÍ∞Ñ Ï†ïÎ≥¥
    let acquiredAt: Date
    var lastUsed: Date?
    
    // ÏãúÏû• Ï†ïÎ≥¥
    var demandMultiplier: Double = 1.0
    let resetInterval: TimeInterval = 3 * 60 * 60 // 3ÏãúÍ∞Ñ
    var lastReset: Date = Date()
    
    // MARK: - Ï¥àÍ∏∞Ìôî
    init(
        itemId: String,
        name: String,
        category: String,
        subcategory: String? = nil,
        grade: ItemGrade,
        rarity: ItemRarity = .common,
        requiredLicense: LicenseLevel,
        requiredLevel: Int = 1,
        requiredStats: RequiredStats? = nil,
        basePrice: Int,
        purchasePrice: Int? = nil,
        currentPrice: Int? = nil,
        weight: Double = 1.0,
        durability: Int? = nil,
        maxStack: Int = 1,
        isStackable: Bool = false,
        isConsumable: Bool = false,
        isTradeable: Bool = true,
        isDropable: Bool = true,
        magicalProperties: [MagicalProperty] = [],
        specialEffects: [SpecialEffect] = [],
        iconId: Int = 1,
        description: String = "",
        loreText: String? = nil,
        acquiredAt: Date = Date()
    ) {
        self.id = UUID().uuidString
        self.itemId = itemId
        self.name = name
        self.category = category
        self.subcategory = subcategory
        self.grade = grade
        self.rarity = rarity
        self.requiredLicense = requiredLicense
        self.requiredLevel = requiredLevel
        self.requiredStats = requiredStats
        self.basePrice = basePrice
        self.purchasePrice = purchasePrice  
        self.currentPrice = currentPrice ?? basePrice
        self.weight = weight
        self.durability = durability
        self.currentDurability = durability
        self.maxStack = maxStack
        self.isStackable = isStackable
        self.isConsumable = isConsumable
        self.isTradeable = isTradeable
        self.isDropable = isDropable
        self.magicalProperties = magicalProperties
        self.specialEffects = specialEffects
        self.iconId = iconId
        self.spriteId = nil
        self.colorScheme = nil
        self.description = description
        self.loreText = loreText
        self.acquiredAt = acquiredAt
    }
    
    // MARK: - ÏÑúÎ≤Ñ ÏùëÎãµÏö© Ï¥àÍ∏∞Ìôî
    init(from serverItem: ServerItemResponse) {
        self.itemId = serverItem.id
        self.name = serverItem.name
        self.category = serverItem.category
        self.subcategory = serverItem.subcategory
        self.grade = ItemGrade(rawValue: serverItem.grade) ?? .common
        self.rarity = ItemRarity(rawValue: serverItem.rarity) ?? .common
        self.requiredLicense = LicenseLevel(rawValue: serverItem.requiredLicense) ?? .beginner
        self.requiredLevel = serverItem.requiredLevel
        self.requiredStats = serverItem.requiredStats
        self.basePrice = serverItem.basePrice
        self.currentPrice = serverItem.currentPrice ?? serverItem.basePrice
        self.marketValue = serverItem.marketValue
        self.purchasePrice = serverItem.purchasePrice
        self.weight = serverItem.weight
        self.durability = serverItem.durability
        self.currentDurability = serverItem.currentDurability ?? serverItem.durability
        self.maxStack = serverItem.maxStack
        self.isStackable = serverItem.isStackable
        self.isConsumable = serverItem.isConsumable
        self.isTradeable = serverItem.isTradeable
        self.isDropable = serverItem.isDropable
        self.enhancementLevel = serverItem.enhancementLevel
        self.enhancementStats = serverItem.enhancementStats
        self.socketGems = serverItem.socketGems ?? []
        self.enchantments = serverItem.enchantments ?? []
        self.customName = serverItem.customName
        self.magicalProperties = serverItem.magicalProperties ?? []
        self.specialEffects = serverItem.specialEffects ?? []
        self.iconId = serverItem.iconId
        self.spriteId = serverItem.spriteId
        self.colorScheme = serverItem.colorScheme
        self.description = serverItem.description
        self.loreText = serverItem.loreText
        self.quantity = serverItem.quantity
        self.isEquipped = serverItem.isEquipped
        self.equipmentSlot = serverItem.equipmentSlot
        self.isLocked = serverItem.isLocked
        self.isFavorite = serverItem.isFavorite
        self.acquiredAt = Date(timeIntervalSince1970: serverItem.acquiredAt)
        self.lastUsed = serverItem.lastUsed != nil ? Date(timeIntervalSince1970: serverItem.lastUsed!) : nil
    }
    
    // MARK: - Î©îÏÑúÎìúÎì§
    mutating func updatePrice(for region: SeoulDistrict) {
        let regionMultiplier = region.priceMultiplier(for: category)
        currentPrice = Int(Double(basePrice) * demandMultiplier * regionMultiplier)
    }
    
    func canUse(by player: Player) -> Bool {
        // Î†àÎ≤® Ï≤¥ÌÅ¨
        guard player.level >= requiredLevel else { return false }
        
        // ÎùºÏù¥ÏÑºÏä§ Ï≤¥ÌÅ¨
        guard player.currentLicense.rawValue >= requiredLicense.rawValue else { return false }
        
        // Ïä§ÌÉØ Ï≤¥ÌÅ¨
        if let reqStats = requiredStats {
            if player.strength < reqStats.strength ||
               player.intelligence < reqStats.intelligence ||
               player.charisma < reqStats.charisma ||
               player.luck < reqStats.luck {
                return false
            }
        }
        
        return true
    }
    
    func getTotalStats() -> ItemStats {
        var stats = ItemStats()
        
        // ÎßàÎ≤ï ÏÜçÏÑ±ÏóêÏÑú Ïä§ÌÉØ Ï∂îÍ∞Ä
        for property in magicalProperties {
            stats = stats.adding(property.stats)
        }
        
        // Í∞ïÌôî Ïä§ÌÉØ Ï∂îÍ∞Ä
        if let enhanceStats = enhancementStats {
            stats = stats.adding(enhanceStats.bonusStats)
        }
        
        // ÏÜåÏºì Ï†¨ÏóêÏÑú Ïä§ÌÉØ Ï∂îÍ∞Ä
        for gem in socketGems {
            stats = stats.adding(gem.stats)
        }
        
        // Ïù∏Ï±àÌä∏ÏóêÏÑú Ïä§ÌÉØ Ï∂îÍ∞Ä
        for enchant in enchantments {
            stats = stats.adding(enchant.stats)
        }
        
        return stats
    }
    
    func getDisplayName() -> String {
        var displayName = customName ?? name
        
        // Í∞ïÌôî ÏàòÏπò ÌëúÏãú
        if enhancementLevel > 0 {
            displayName = "+\(enhancementLevel) \(displayName)"
        }
        
        return displayName
    }
    
    func getQualityColor() -> ItemQualityColor {
        // Îì±Í∏âÍ≥º Ìù¨Í∑ÄÎèÑÎ•º Ï°∞Ìï©Ìï¥ÏÑú ÏÉâÏÉÅ Í≤∞Ï†ï
        if rarity == .legendary {
            return .legendary
        } else if rarity == .epic {
            return .epic
        } else if enhancementLevel >= 7 {
            return .masterwork
        } else if enhancementLevel >= 4 {
            return .superior
        } else {
            switch grade {
            case .legendary: return .legendary
            case .rare: return .rare
            case .advanced: return .uncommon
            case .intermediate: return .common
            case .common: return .poor
            }
        }
    }
}

// MARK: - ÏßÄÏõê Íµ¨Ï°∞Ï≤¥Îì§
struct RequiredStats: Codable, Equatable {
    let strength: Int
    let intelligence: Int
    let charisma: Int
    let luck: Int
    
    init(strength: Int = 0, intelligence: Int = 0, charisma: Int = 0, luck: Int = 0) {
        self.strength = strength
        self.intelligence = intelligence
        self.charisma = charisma
        self.luck = luck
    }
}

struct ItemStats: Codable, Equatable {
    var strength: Int = 0
    var intelligence: Int = 0
    var charisma: Int = 0
    var luck: Int = 0
    var tradingSkill: Int = 0
    var negotiationSkill: Int = 0
    var appraisalSkill: Int = 0
    
    func adding(_ other: ItemStats) -> ItemStats {
        return ItemStats(
            strength: self.strength + other.strength,
            intelligence: self.intelligence + other.intelligence,
            charisma: self.charisma + other.charisma,
            luck: self.luck + other.luck,
            tradingSkill: self.tradingSkill + other.tradingSkill,
            negotiationSkill: self.negotiationSkill + other.negotiationSkill,
            appraisalSkill: self.appraisalSkill + other.appraisalSkill
        )
    }
}

struct EnhancementStats: Codable, Equatable {
    let bonusStats: ItemStats
    let specialAbilities: [String]
    let visualEffects: [String]
}

struct SocketGem: Identifiable, Codable, Equatable {
    let id = UUID()
    let name: String
    let type: GemType
    let stats: ItemStats
    let visualEffect: String?
    
    enum GemType: String, CaseIterable, Codable {
        case ruby = "Î£®ÎπÑ"        // Ìûò Ï¶ùÍ∞Ä
        case sapphire = "ÏÇ¨ÌååÏù¥Ïñ¥"  // ÏßÄÎä• Ï¶ùÍ∞Ä
        case emerald = "ÏóêÎ©îÎûÑÎìú"   // Îß§Î†• Ï¶ùÍ∞Ä
        case diamond = "Îã§Ïù¥ÏïÑÎ™¨Îìú"  // ÌñâÏö¥ Ï¶ùÍ∞Ä
        case pearl = "ÏßÑÏ£º"        // Í±∞Îûò Í∏∞Ïà† Ï¶ùÍ∞Ä
    }
}

struct Enchantment: Identifiable, Codable, Equatable {
    let id = UUID()
    let name: String
    let type: EnchantmentType
    let stats: ItemStats
    let description: String
    let visualEffect: String?
    
    enum EnchantmentType: String, CaseIterable, Codable {
        case blessing = "Ï∂ïÎ≥µ"
        case curse = "Ï†ÄÏ£º"
        case enhancement = "Í∞ïÌôî"
        case protection = "Î≥¥Ìò∏"
        case luck = "ÌñâÏö¥"
    }
}

struct MagicalProperty: Identifiable, Codable, Equatable {
    let id = UUID()
    let name: String
    let type: MagicType
    let stats: ItemStats
    let description: String
    let rarity: ItemRarity
    
    enum MagicType: String, CaseIterable, Codable {
        case elemental = "ÏõêÏÜå"
        case statBoost = "Îä•Î†•Ïπò"
        case skillBoost = "Í∏∞Ïà†"
        case special = "ÌäπÏàò"
        case aura = "Ïò§Îùº"
    }
}

struct SpecialEffect: Identifiable, Codable, Equatable {
    let id = UUID()
    let name: String
    let description: String
    let effectType: EffectType
    let value: Double
    let duration: TimeInterval?
    
    enum EffectType: String, CaseIterable, Codable {
        case priceDiscount = "Í∞ÄÍ≤©Ìï†Ïù∏"
        case experienceBonus = "Í≤ΩÌóòÏπòÎ≥¥ÎÑàÏä§"
        case luckBonus = "ÌñâÏö¥Î≥¥ÎÑàÏä§"
        case speedBoost = "ÏÜçÎèÑÏ¶ùÍ∞Ä"
        case protectionBarrier = "Î≥¥Ìò∏Îßâ"
        case manaRegeneration = "ÎßàÎÇòÌöåÎ≥µ"
        case goldFind = "Í≥®ÎìúÎ∞úÍ≤¨"
        case rareItemFind = "Ìù¨Í∑ÄÏïÑÏù¥ÌÖúÎ∞úÍ≤¨"
    }
}

enum ItemRarity: String, CaseIterable, Codable {
    case common = "common"
    case uncommon = "uncommon"
    case rare = "rare"
    case epic = "epic"
    case legendary = "legendary"
    case mythic = "mythic"  // ÏÉàÎ°ú Ï∂îÍ∞Ä
    
    var displayName: String {
        switch self {
        case .common: return "ÏùºÎ∞ò"
        case .uncommon: return "Í≥†Í∏â"
        case .rare: return "Ìù¨Í∑Ä"
        case .epic: return "ÏòÅÏõÖ"
        case .legendary: return "Ï†ÑÏÑ§"
        case .mythic: return "Ïã†Ìôî"
        }
    }
    
    var color: ItemQualityColor {
        switch self {
        case .common: return .common
        case .uncommon: return .uncommon
        case .rare: return .rare
        case .epic: return .epic
        case .legendary: return .legendary
        case .mythic: return .mythic
        }
    }
}

enum EquipmentSlot: String, CaseIterable, Codable {
    case helmet = "helmet"
    case armor = "armor"
    case weapon = "weapon"
    case accessory = "accessory"
    case tool = "tool"
    case consumable = "consumable"
}

enum ItemQualityColor: CaseIterable {
    case poor, common, uncommon, rare, epic, legendary, mythic, masterwork, superior
    
    var color: SwiftUI.Color {
        switch self {
        case .poor: return .gray
        case .common: return .primary
        case .uncommon: return .green
        case .rare: return .blue
        case .epic: return .purple
        case .legendary: return .orange
        case .mythic: return .red
        case .masterwork: return .yellow
        case .superior: return .cyan
        }
    }
}

// MARK: - ÏÑúÎ≤Ñ ÏùëÎãµ Î™®Îç∏
struct ServerItemResponse: Codable {
    let id: String
    let name: String
    let category: String
    let subcategory: String?
    let grade: String
    let rarity: String
    let requiredLicense: Int
    let requiredLevel: Int
    let requiredStats: RequiredStats?
    let basePrice: Int
    let currentPrice: Int?
    let marketValue: Int?
    let purchasePrice: Int?
    let weight: Double
    let durability: Int?
    let currentDurability: Int?
    let maxStack: Int
    let isStackable: Bool
    let isConsumable: Bool
    let isTradeable: Bool
    let isDropable: Bool
    let enhancementLevel: Int
    let enhancementStats: EnhancementStats?
    let socketGems: [SocketGem]?
    let enchantments: [Enchantment]?
    let customName: String?
    let magicalProperties: [MagicalProperty]?
    let specialEffects: [SpecialEffect]?
    let iconId: Int
    let spriteId: Int?
    let colorScheme: String?
    let description: String
    let loreText: String?
    let quantity: Int
    let isEquipped: Bool
    let equipmentSlot: EquipmentSlot?
    let isLocked: Bool
    let isFavorite: Bool
    let acquiredAt: TimeInterval
    let lastUsed: TimeInterval?
}
